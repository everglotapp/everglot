version: "3"

services:
    everglot-app:
        environment:
            NODE_ENV: "production"
            ROARR_LOG: "true"
            HOST: "0.0.0.0"
            PORT: "3000"
            DISABLE_SECURE_COOKIES: "true"
        entrypoint: entrypoints/ci-after-db.sh
        command: ["npm", "start"]
        # Avoid building the same image twice.
        image: everglot-app-image

    everglot-app-ci:
        environment:
            NODE_ENV: "test"
            BASE_URL: "http://everglot-app:3000"
            ROARR_LOG: "true"
            PGUSER: "everglot_app_user"
            PGPASSWORD: "everglot_app_pass"
            PGDATABASE: "everglot_app_db"
            PGHOST: "everglot-db"
            PGPORT: "5432"
            DATABASE_URL: "postgres://everglot_app_user:everglot_app_pass@everglot-db:5432/everglot_app_db"
            SESSION_COOKIE_VALIDATION_SECRETS: "${SESSION_COOKIE_VALIDATION_SECRETS:?Please set SESSION_COOKIE_VALIDATION_SECRETS}"
            SESSION_COOKIE_NAME: "${SESSION_COOKIE_NAME:-everglot_sid}"
            AGORA_APP_CERTIFICATE: ""
            SENDINBLUE_API_KEY: ""
        entrypoint: entrypoints/ci-after-app.sh
        # Avoid building the same image twice.
        image: everglot-app-image
        depends_on:
            - everglot-app

    everglot-db:
        environment:
            POSTGRES_USER: "everglot_app_user"
            POSTGRES_PASSWORD: "everglot_app_pass"
            POSTGRES_DB: "everglot_app_db"
